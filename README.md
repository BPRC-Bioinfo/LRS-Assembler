# Long Read Sequencing - Assembler

This Snakemake workflow facilitates the hybrid assembly of long-read datasets generated by Oxford Nanopore Technologies (ONT) and Pacific Biosciences (PacBio) platforms. Designed for scalability and flexibility, it is an ideal solution to assemble near-complete genomes with minimal number of gaps.

In addition to genome assembly, the workflow supports the phasing and annotation of user-specified regions, such as highly heterozygous immune-related haplotypes. By utilizing the high contiguity of paternal and maternal contigs produced by hifiasm, and integrating a user-provided reference sequence database, it enables accurate annotation of these regions. 

## Installation Guide

To download the pipeline, the repository can be cloned using the following command:

    git clone git@github.com:BPRC-Bioinfo/LRS-Assembler.git
    cd ./LRS-Assembler

Then install the pipeline dependencies in a new enviroment:

    conda env create -f envs/LRS-assembler.yaml
    conda activate lrs_pipe

## Usage Guide

Before running LRS-Assembler, the user has to provide the input data files in the specified structure and define the analysis variables in the configuration file. This file should specify the scientific name of the species studied and, optionally, include details on the flanking genes of the regions of interest and the location of the reference library. If necessary, the user can also adjust the mapping settings.

### Input Data

The input data should be organized in the following manner:

```
raws/
├── sample1/
│   ├── nanopore/
│   │   └── reads.fastq.gz
│   └── pacbio/
│       └── reads.bam
├── sample2/
│   ├── nanopore/
│   │   └── reads.fastq.gz
│   └── pacbio/
│       └── reads.bam
```

The ONT reads do not need to be combined into a single file prior to starting the pipeline.
The pipeline can process data from multiple samples in parallel, which will help speed up the overall processing time.

### Updating User-specific Variables

Users should specify the scientific name of the species being studied. Optionally, users can also define regions of interest, which are identified by their flanking genes. Flanking genes are those located adjacent to the region of interest, and the provided gene names should match those listed in the NCBI database for the specified species. 

To annotate the specified regions, a reference database must be specified in the configuration file. The choice of the minimap2 command depends on whether the reference database contains genomic or transcriptomic sequences. For mapping transcriptomic data to genomic assemblies, the ```splice:hq``` option should be used. For genomic reference databases, options such as ```-ax asm5``` or ```-ax asm10``` are recommended.

A config file looks like:
```
species: "macaca mulatta"
region:
  KIR:
    left_flank: "FCAR"
    right_flank: "LILRA6"
    library: "references/mamu_kir_gen_2501.fasta" 
    minimap2: "-cx splice:hq -G16k"
    blast: "-word_size 7"
```

### Run The Pipeline

To execute the pipeline, ensure that the input data is placed in the specified directory and the variables in the configuration file are properly defined. Then, run the following command:

```
snakemake --cores <number_of_cores> -s scripts/Snakefile --use-conda
```

## Output

For each sample, a set of output files is generated, organized as outlined below:

```
.
└── results/
    └── sample/
        ├── hifiasm/
        │   └── All data generated by hifiasm
        ├── info/
        │   └── Different files containing information on the assembly
        ├── intermediates/
        │   └── Intermediate working files
        ├── ntLink/
        │   └── Scaffolds after ntLink
        ├── ragtag/
        │   └── Scaffolds after ntLink and Ragtag
        ├── raws/
        │   └── Size-filtered (5000 bp) raw HiFi and ONT reads
        └── scaffolds/
            └── All final scaffolds generated by LRS-Assembler
```

## Features

  * Support for ONT and PacBio: Assemble genomes using both sequencing platforms for a hybrid assembly.
  * Automatic Sample Detection: The pipeline automatically detects input data, ensuring it only processes samples with both ONT and PacBio reads.
  * Configurable Assembly Options: Users can customize the workflow by providing references for alignment and comparison.
  * Reference Comparison: Align assembled sequences to reference genomes and compute assembly statistics.

## Workflow Overview

(Figure)

The workflow automatically detects samples and processes only those that contain both ONT and PacBio data, ensuring hybrid assembly:

  * Input Files Detection: The workflow searches for ONT .fastq.gz and PacBio .bam files in the designated directories.
  * Hybrid Assembly: The pipeline performs assembly using tools optimized for combining ONT and PacBio reads for higher assembly accuracy.
  * Contig lengthening using long reads
  * Scaffolding based on the reference genome provided
  * Evaluate using BUSCO and Quast
  * Post-assembly Processing: The assembled sequences are aligned to multiple references and statistics are computed for evaluation.

Requirements

    Snakemake (>=6.0)
    Pandas 2.2.3
    Python 3.12.7

Installation

    Clone this repository:

    git clone git@github.com:BPRC-Bioinfo/LRS-Assembler.git
    cd LRS-Assembler

    Install environment:
    
    conda env create -f envs/LRS-assembler.yaml
    conda activate lrs_pipe
    
    Customize the configs/run-config.yaml file with your reference genome information and other settings.

Input Data Structure

The input data should be organized as follows:

```
raws/
├── sample1/
│   ├── nanopore/
│   │   └── reads.fastq.gz
│   └── pacbio/
│       └── reads.bam
├── sample2/
│   ├── nanopore/
│   │   └── reads.fastq.gz
│   └── pacbio/
│       └── reads.bam
```
Configuration

Here is an example run-config.yaml file:

```
species: "macaca mulatta"
region:
  KIR:
    left_flank: "FCAR"
    right_flank: "LILRA6"
    library: "references/mamu_kir_gen_2501.fasta" 
    minimap2: "-cx splice:hq -G16k"
    blast: "-word_size 7"
```

Edit the configs/run-config.yaml file to specify:

    Library: Paths to reference files used for alignment.
    Minimap2: Customize command for minimap2
    blast: Customize command for blastn

Execution

Run the workflow with Snakemake:

```
snakemake --cores <number_of_cores> -s scripts/Snakefile --use-conda
```


Output

The output files are stored in the results/ directory. For each sample and assembly method, you will obtain:

    Assembly files in .fasta format
    Alignment statistics in .csv format

Contribution

Contributions are welcome! Feel free to submit a pull request or open an issue.
License

This project is licensed under the MIT License

To be add:
  * Example
  * Annotation
  * Remove Flye
