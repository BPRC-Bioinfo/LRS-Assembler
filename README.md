# Long Read Sequencing - Assembler

This Snakemake workflow facilitates the hybrid assembly of long-read datasets generated by Oxford Nanopore Technologies (ONT) and Pacific Biosciences (PacBio) platforms. Designed for scalability and flexibility, it is an ideal solution to assemble near-complete genomes with minimal number of gaps.

In addition to genome assembly, the workflow supports the phasing and annotation of user-specified regions, such as highly heterozygous immune-related haplotypes. By utilizing the high contiguity of paternal and maternal contigs produced by hifiasm, and integrating a user-provided reference sequence database, it enables accurate annotation of these regions. 

## Installation Guide

To download the pipeline, the repository can be cloned using the following command:

    git clone git@github.com:BPRC-Bioinfo/LRS-Assembler.git
    cd ./LRS-Assembler

Then install the pipeline dependencies in a new enviroment:

    conda env create -f envs/LRS-assembler.yaml
    conda activate lrs_pipe

## Usage Guide

Before running LRS-Assembler, the user has to provide the location of the input data files and define the analysis variables in the configuration file. This file should specify the scientific name of the species studied and, optionally, include details on the flanking genes of the regions of interest and the location of the reference library. If necessary, the user can also adjust the settings for LiftOff, BUSCO and minimap2.

### Updating User-specific Variables

Users should specify the scientific name of the species being studied. Optionally, users can also define regions of interest, which are identified by their flanking genes. Flanking genes are those located adjacent to the region of interest, and the provided gene names should match those listed in the NCBI database for the specified species. 

To annotate the specified regions, a reference database must be specified in the configuration file. The choice of the minimap2 command depends on whether the reference database contains genomic or transcriptomic sequences. For mapping transcriptomic data to genomic assemblies, the ```splice:hq``` option should be used. For genomic reference databases, options such as ```-ax asm5``` or ```-ax asm10``` are recommended.

A config file looks like:

```
cat configs/run-config.yaml
```
```
species: "Macaca mulatta"
reference:
  GCF_003339765.1:
    accession_number: "GCF_003339765.1"
    genome: "/path/to/local/reference/genomic.fna"
    gff: "/path/to/local.gff"
    chr_info: "/path/to/local/chr_info_file"
region:
  KIR:
    left_flank: "FCAR"
    right_flank: "LILRA6"
    library: "references/mamu_kir_gen_2501.fasta" 
    minimap2: "-cx splice:hq -G16k"
    blast: "-word_size 7"
  MHC:
    left_flank: "KIFC1"
    right_flank: "GABBR1"
    library: "references/mamu_mhc_gen_2501.fasta" 
    minimap2: "-cx splice:hq -G16k "
    blast: "-word_size 7"
busco: "primates_odb10"
nanopore:
  Sample_1:
    - "/path/to/local/SampleA/nanopore/fastq1"
    - "/path/to/local/SampleA/nanopore/fastq2"
  Sample_2:
    - "/path/to/local/SampleB/nanopore/fastq1"
    - "/path/to/local/SampleB/nanopore/fastq2"
pacbio:
  Sample_1:
    - "/path/to/local/SampleA/pacbio/bam1"
    - "/path/to/local/SampleA/pacbio/bam2"
  Sample_2:
    - "/path/to/local/SampleB/pacbio/bam1"
```

### Input Data

The input data should be organized in the following manner:

```
raws/
├── sample1/
│   ├── nanopore/
│   │   └── reads.fastq.gz
│   └── pacbio/
│       └── reads.bam
├── sample2/
│   ├── nanopore/
│   │   └── reads.fastq.gz
│   └── pacbio/
│       └── reads.bam
```

The ONT reads do not need to be combined into a single file prior to starting the pipeline.
The pipeline can process data from multiple samples in parallel, which will help speed up the overall processing time.

### Updating User-specific Variables

Users should specify the scientific name of the species being studied. Optionally, users can also define regions of interest, which are identified by their flanking genes. Flanking genes are those located adjacent to the region of interest, and the provided gene names should match those listed in the NCBI database for the specified species. 

To annotate the specified regions, a reference database must be specified in the configuration file. The choice of the minimap2 command depends on whether the reference database contains genomic or transcriptomic sequences. For mapping transcriptomic data to genomic assemblies, the ```splice:hq``` option should be used. For genomic reference databases, options such as ```-ax asm5``` or ```-ax asm10``` are recommended.

A config file looks like:
```
species: "macaca mulatta"
region:
  KIR:
    left_flank: "FCAR"
    right_flank: "LILRA6"
    library: "references/mamu_kir_gen_2501.fasta" 
    minimap2: "-cx splice:hq -G16k"
    blast: "-word_size 7"
```

### Run The Pipeline

To execute the pipeline, ensure that the input data is placed in the specified directory and the variables in the configuration file are properly defined. Then, run the following command:

```
snakemake --cores <number_of_cores> -s scripts/Snakefile --use-conda
```

## Output

For each sample, a set of output files is generated, organized as outlined below:

```
.
└── results/
    └── sample_name/
        ├── hifiasm/
        │   └── All data generated by hifiasm
        ├── info/
        │   └── Different files containing information on the assembly, like number of contigs and N50 lengths 
        ├── intermediates/
        │   └── Intermediate working files
        ├── ntLink/
        │   └── Scaffolds after ntLink
        ├── ragtag/
        │   └── Scaffolds after ntLink and Ragtag
        ├── raws/
        │   └── Size-filtered (5000 bp) raw HiFi and ONT reads
        └── scaffolds/
            └── All final scaffolds generated by LRS-Assembler
```

## Sample Data

The pipeline has been developed and validated using HiFi and ONT long-read datasets derived from rhesus macaque of Indian origin and human samples HG01109, HG02080, and HG02723 from the Human Pangenome Reference Consortium (HPRC). The rhesus macaque data has been submitted to the European Nucleotide Archive (ENA, https://www.ebi.ac.uk/ena/browser/home) under project number PRJEB84466. 

## Troubleshooting

If you encounter any issues with genome assembly or RIO extraction and annotation, please feel free to contact us at le@bprc.nl or bruijnesteijn@bprc.nl, or report the issue directly in this repository. The pipeline is under continuous development to improve genome assemblies and enhance haplotype annotations.

## Cite

The manuscript detailing LRS-Assembler is currently in preparation.
